/**
  ******************************************************************************
  * @file    bsp_led.c
  * @author  fire
  * @version V1.0
  * @date    2013-xx-xx
  * @brief   ????IIC ????
  ******************************************************************************
  * @attention
  *
  * ?????:??? F103-??? STM32 ??????
  * ???    :http://www.firebbs.cn
  * ???    :https://fire-stm32.taobao.com
  *
  ******************************************************************************
  */

/*
	????????
	?????IIC?��?????????? IIC_CheckDevice() ???IIC?��??????????��?????????GPIO
*/

#include "stm32f1xx_hal.h"
#include "i2c_dev.h"

/* ????IIC?????????GPIO???, ??????????????4?��???????????SCL??SDA?????? */
#define GPIO_PORT_IIC     GPIOB                       /* GPIO??? */
#define RCC_IIC_ENABLE    __HAL_RCC_GPIOB_CLK_ENABLE()       /* GPIO?????? */
#define IIC_SCL_PIN       GPIO_PIN_8                  /* ?????SCL??????GPIO */
#define IIC_SDA_PIN       GPIO_PIN_9                  /* ?????SDA???????GPIO */

/* ?????��SCL??SDA?????????????????????????? */
#if 1	/* ???????? 1 ???GPIO????????IO??�� */
#define IIC_SCL_1()  HAL_GPIO_WritePin(GPIO_PORT_IIC, IIC_SCL_PIN, GPIO_PIN_SET)		/* SCL = 1 */
#define IIC_SCL_0()  HAL_GPIO_WritePin(GPIO_PORT_IIC, IIC_SCL_PIN, GPIO_PIN_RESET)		/* SCL = 0 */

#define IIC_SDA_1()  HAL_GPIO_WritePin(GPIO_PORT_IIC, IIC_SDA_PIN, GPIO_PIN_SET)		/* SDA = 1 */
#define IIC_SDA_0()  HAL_GPIO_WritePin(GPIO_PORT_IIC, IIC_SDA_PIN, GPIO_PIN_RESET)		/* SDA = 0 */

#define IIC_SDA_READ()  HAL_GPIO_ReadPin(GPIO_PORT_IIC, IIC_SDA_PIN)	/* ??SDA?????? */
#else	/* ???????????????????????IO??�� */
/*?????????��??????IAR??????????????????????????? */
#define IIC_SCL_1()  GPIO_PORT_IIC->BSRR = IIC_SCL_PIN				/* SCL = 1 */
#define IIC_SCL_0()  GPIO_PORT_IIC->BRR = IIC_SCL_PIN				/* SCL = 0 */

#define IIC_SDA_1()  GPIO_PORT_IIC->BSRR = IIC_SDA_PIN				/* SDA = 1 */
#define IIC_SDA_0()  GPIO_PORT_IIC->BRR = IIC_SDA_PIN				/* SDA = 0 */

#define IIC_SDA_READ()  ((GPIO_PORT_IIC->IDR & IIC_SDA_PIN) != 0)	/* ??SDA?????? */
#endif

void IIC_GPIO_Init(void);


static void IIC_Delay(void)
{
    uint8_t i;


    for (i = 0; i < 10; i++);
}

/*
*********************************************************************************************************
*	?? ?? ??: IIC_Start
*	???????: CPU????IIC???????????
*	??    ?��???
*	?? ?? ?: ??
*********************************************************************************************************
*/
void IIC_Start(void)
{
    /* ??SCL???????SDA???????????????IIC??????????? */
    IIC_SDA_1();
    IIC_SCL_1();
    IIC_Delay();
    IIC_SDA_0();
    IIC_Delay();
    IIC_SCL_0();
    IIC_Delay();
}

/*
*********************************************************************************************************
*	?? ?? ??: IIC_Start
*	???????: CPU????IIC?????????
*	??    ?��???
*	?? ?? ?: ??
*********************************************************************************************************
*/
void IIC_Stop(void)
{
    /* ??SCL???????SDA???????????????IIC????????? */
    IIC_SDA_0();
    IIC_SCL_1();
    IIC_Delay();
    IIC_SDA_1();
}

/*
*********************************************************************************************************
*	?? ?? ??: IIC_SendByte
*	???????: CPU??IIC?????��????8bit????
*	??    ?��?_ucByte ?? ???????????
*	?? ?? ?: ??
*********************************************************************************************************
*/
void IIC_Send_Byte(uint8_t _ucByte)
{
    uint8_t i;

    /* ??????????��bit7 */
    for (i = 0; i < 8; i++)
    {
        if (_ucByte & 0x80)
        {
            IIC_SDA_1();
        }
        else
        {
            IIC_SDA_0();
        }
        IIC_Delay();
        IIC_SCL_1();
        IIC_Delay();
        IIC_SCL_0();
        if (i == 7)
        {
            IIC_SDA_1(); // ???????
        }
        _ucByte <<= 1;	/* ???????bit */
        IIC_Delay();
    }
}

/*
*********************************************************************************************************
*	?? ?? ??: IIC_ReadByte
*	???????: CPU??IIC?????��???8bit????
*	??    ?��???
*	?? ?? ?: ??????????
*********************************************************************************************************
*/
uint8_t IIC_Read_Byte(uint8_t ack)
{
    uint8_t i;
    uint8_t value;

    /* ??????1??bit??????bit7 */
    value = 0;
    for (i = 0; i < 8; i++)
    {
        value <<= 1;
        IIC_SCL_1();
        IIC_Delay();
        if (IIC_SDA_READ())
        {
            value++;
        }
        IIC_SCL_0();
        IIC_Delay();
    }
    if(ack==0)
        IIC_NAck();
    else
        IIC_Ack();
    return value;
}

/*
*********************************************************************************************************
*	?? ?? ??: IIC_WaitAck
*	???????: CPU??????????????????????ACK??????
*	??    ?��???
*	?? ?? ?: ????0?????????1????????????
*********************************************************************************************************
*/
uint8_t IIC_Wait_Ack(void)
{
    uint8_t re;

    IIC_SDA_1();	/* CPU???SDA???? */
    IIC_Delay();
    IIC_SCL_1();	/* CPU????SCL = 1, ???????????ACK??? */
    IIC_Delay();
    if (IIC_SDA_READ())	/* CPU???SDA?????? */
    {
        re = 1;
    }
    else
    {
        re = 0;
    }
    IIC_SCL_0();
    IIC_Delay();
    return re;
}

/*
*********************************************************************************************************
*	?? ?? ??: IIC_Ack
*	???????: CPU???????ACK???
*	??    ?��???
*	?? ?? ?: ??
*********************************************************************************************************
*/
void IIC_Ack(void)
{
    IIC_SDA_0();	/* CPU????SDA = 0 */
    IIC_Delay();
    IIC_SCL_1();	/* CPU????1????? */
    IIC_Delay();
    IIC_SCL_0();
    IIC_Delay();
    IIC_SDA_1();	/* CPU???SDA???? */
}

/*
*********************************************************************************************************
*	?? ?? ??: IIC_NAck
*	???????: CPU????1??NACK???
*	??    ?��???
*	?? ?? ?: ??
*********************************************************************************************************
*/
void IIC_NAck(void)
{
    IIC_SDA_1();	/* CPU????SDA = 1 */
    IIC_Delay();
    IIC_SCL_1();	/* CPU????1????? */
    IIC_Delay();
    IIC_SCL_0();
    IIC_Delay();
}

/*
*********************************************************************************************************
*	?? ?? ??: IIC_GPIO_Config
*	???????: ????IIC?????GPIO?????????IO???????
*	??    ?��???
*	?? ?? ?: ??
*********************************************************************************************************
*/
void IIC_GPIO_Init(void)
{
    GPIO_InitTypeDef GPIO_InitStructure;

    RCC_IIC_ENABLE;	/* ??GPIO??? */

    GPIO_InitStructure.Pin = IIC_SCL_PIN | IIC_SDA_PIN;
    GPIO_InitStructure.Speed = GPIO_SPEED_FREQ_LOW;
    GPIO_InitStructure.Mode = GPIO_MODE_OUTPUT_OD;  	/* ?????? */
    HAL_GPIO_Init(GPIO_PORT_IIC, &GPIO_InitStructure);

    /* ??????????, ??��IIC????????????��???????? */
    IIC_Stop();
}

/*
*********************************************************************************************************
*	?? ?? ??: IIC_CheckDevice
*	???????: ???IIC?????��??CPU?????��???????????��??????��???��??????
*	??    ?��?_Address???��??IIC??????
*	?? ?? ?: ????? 0 ???????? ????1???��???
*********************************************************************************************************
*/
uint8_t IIC_CheckDevice(uint8_t _Address)
{
    uint8_t ucAck;

    IIC_GPIO_Init();		/* ????GPIO */

    IIC_Start();		/* ??????????? */

    /* ?????��???+??��????bit??0 = w?? 1 = r) bit7 ??? */
    IIC_Send_Byte(_Address|IIC_WR);
    ucAck = IIC_Wait_Ack();	/* ????��??ACK??? */

    IIC_Stop();			/* ????????? */

    return ucAck;
}
